<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ ‚Äî –≤—Ö–æ–¥</title>
  <style>
    :root{--b:#e5e7eb;--bg:#f8fafc;--muted:#6b7280;--pri:#2563eb;--pri2:#dbeafe}
    *{box-sizing:border-box} body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#0f172a}
    h1,h2{margin:0 0 12px 0}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .card{border:1px solid var(--b);border-radius:12px;background:#fff;padding:14px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
    input,select,button{padding:10px;border:1px solid var(--b);border-radius:10px;font-size:14px;background:#fff}
    input,select{min-width:160px} button{cursor:pointer}
    button.primary{background:var(--pri);color:#fff;border-color:var(--pri)}
    .muted{color:var(--muted)} .note{font-size:12px;color:var(--muted);margin-top:8px}
    .student{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border:1px solid var(--b);
      border-radius:10px;margin:6px 0;background:#fff}
    .student.active{background:var(--pri2);border-color:var(--pri)}
    table{width:100%;border-collapse:collapse;margin-top:8px} th,td{border-bottom:1px solid var(--b);padding:6px 8px;text-align:left}
    .auth-wrap{display:grid;grid-template-columns:1fr 1fr; gap:16px}
    .right{display:flex;justify-content:flex-end;gap:8px;align-items:center}
    .pill{padding:6px 10px;border:1px solid var(--b);border-radius:999px;background:#fff}
    @media(max-width:980px){.grid{grid-template-columns:1fr}.auth-wrap{grid-template-columns:1fr} .right{justify-content:flex-start; margin-top:8px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div>
        <h1>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h1>
        <div class="muted">–í—Ö–æ–¥ –ø–æ email –∏ –ø–∞—Ä–æ–ª—é (Firebase Auth)</div>
      </div>
      <div class="right">
        <span id="who" class="muted pill"></span>
        <button id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authSection" class="card">
      <div class="auth-wrap">
        <div class="card" style="border:none;padding:0">
          <h2>–í–æ–π—Ç–∏</h2>
          <div class="row"><input id="loginEmail" placeholder="email" type="email"/></div>
          <div class="row"><input id="loginPass"  placeholder="–ø–∞—Ä–æ–ª—å" type="password"/></div>
          <div class="row">
            <button id="loginBtn" class="primary">–í–æ–π—Ç–∏</button>
            <button id="resetBtn">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
          </div>
          <div id="loginMsg" class="note"></div>
        </div>

        <div class="card" style="border:none;padding:0">
          <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
          <div class="row"><input id="regEmail" placeholder="email" type="email"/></div>
          <div class="row"><input id="regPass"  placeholder="–ø–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" type="password"/></div>
          <div class="row"><button id="regBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button></div>
          <div id="regMsg" class="note"></div>
        </div>
      </div>

      <div class="note">
        –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –æ–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –ø—Ä–∞–≤–∏–ª–∞–º–∏ Firestore –ø–æ email –∞–¥—Ä–µ—Å–∞–º (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é).
      </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <div id="appSection" style="display:none">
      <div class="grid">
        <!-- –ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="card">
          <h2>–£—á–µ–Ω–∏–∫–∏</h2>
          <div class="row">
            <input id="newName" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è"/>
            <button id="addStudent" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div id="students"></div>
        </div>

        <!-- –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
        <div class="card" id="detail"><div class="muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ —Å–ª–µ–≤–∞</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (–º–æ–¥—É–ª—å–Ω—ã–π) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc,
      onSnapshot, orderBy, query, writeBatch, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 1) –í–°–¢–ê–í–¨ –°–í–û–ô firebaseConfig –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
    const firebaseConfig = {
  apiKey: "AIzaSyBxxWRUZ6Ma7vENJcZF40sQ39-t_pU",
  authDomain: "grades-app-1b88e.firebaseapp.com",
  projectId: "grades-app-1b88e",
  storageBucket: "grades-app-1b88e.appspot.com",
  messagingSenderId: "184824916315",
  appId: "1:184824916315:web:2120d167b06395a880d27e",
  measurementId: "G-R9PXHDSXZJ"
};


    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ===== UI helper
    const $ = s => document.querySelector(s);
    const authSection = $("#authSection");
    const appSection  = $("#appSection");
    const who         = $("#who");
    const logoutBtn   = $("#logoutBtn");

    // ===== Firestore refs
    const colStudents = () => collection(db, "class", "shared", "students");
    const gradesCol   = (studentId) => collection(doc(colStudents(), studentId), "grades");
    const subjectsCol = (studentId) => collection(doc(colStudents(), studentId), "subjects");

    // ===== Auth state
    onAuthStateChanged(auth, (user)=>{
      if (user) {
        who.textContent = user.email || "(–±–µ–∑ email)";
        logoutBtn.style.display = "inline-block";
        authSection.style.display = "none";
        appSection.style.display  = "block";
        startStudentsListener();
      } else {
        who.textContent = "";
        logoutBtn.style.display = "none";
        appSection.style.display  = "none";
        authSection.style.display = "block";
        stopStudentsListener();
      }
    });

    logoutBtn.onclick = ()=> signOut(auth);

    // ===== Login/Register/Reset
    $("#loginBtn").onclick = async ()=>{
      $("#loginMsg").textContent = "";
      try {
        await signInWithEmailAndPassword(auth, $("#loginEmail").value, $("#loginPass").value);
      } catch (e) {
        $("#loginMsg").textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + (e.message || e);
      }
    };

    $("#regBtn").onclick = async ()=>{
      $("#regMsg").textContent = "";
      try {
        await createUserWithEmailAndPassword(auth, $("#regEmail").value, $("#regPass").value);
        $("#regMsg").textContent = "–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.";
      } catch (e) {
        $("#regMsg").textContent = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + (e.message || e);
      }
    };

    $("#resetBtn").onclick = async ()=>{
      $("#loginMsg").textContent = "";
      try {
        await sendPasswordResetEmail(auth, $("#loginEmail").value);
        $("#loginMsg").textContent = "–ü–∏—Å—å–º–æ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.";
      } catch (e) {
        $("#loginMsg").textContent = "–û—à–∏–±–∫–∞: " + (e.message || e);
      }
    };

    // ===== Students + grades
    let unsubStudents = null, unsubGrades = null, unsubSubjects = null;
    let activeStudentId = null;
    let subjects = []; // —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞

    function stopStudentsListener(){
      unsubStudents && unsubStudents(); unsubStudents = null;
      unsubGrades && unsubGrades();     unsubGrades = null;
      unsubSubjects && unsubSubjects(); unsubSubjects = null;
    }

    function startStudentsListener(){
      stopStudentsListener();
      const q = query(colStudents(), orderBy("name"));
      unsubStudents = onSnapshot(q, snap=>{
        const box = $("#students"); box.innerHTML="";
        snap.forEach(d=>{
          const s = { id: d.id, ...d.data() };
          const row = document.createElement("div");
          row.className = "student" + (s.id === activeStudentId ? " active" : "");

          const btn = document.createElement("button");
          btn.textContent = s.name;
          btn.style.flex = "1";
          btn.onclick = ()=> showStudent(s.id);

          const rename = document.createElement("button");
          rename.textContent = "‚úèÔ∏è";
          rename.title = "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å";
          rename.onclick = async (e)=>{
            e.stopPropagation();
            const n = prompt("–ù–æ–≤–æ–µ –∏–º—è:", s.name);
            if (!n) return;
            await setDoc(doc(colStudents(), s.id), {name:n});
            if (s.id===activeStudentId) $("#studentTitle").textContent = n;
          };

          const del = document.createElement("button");
          del.textContent = "üóë";
          del.title = "–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞";
          del.onclick = async (e)=>{
            e.stopPropagation();
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${s.name}¬ª –∏ –í–°–ï –µ–≥–æ –æ—Ü–µ–Ω–∫–∏?`)) return;
            await deleteStudentDeep(s.id);
            if (s.id===activeStudentId) {
              activeStudentId=null;
              $("#detail").innerHTML = '<div class="muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ —Å–ª–µ–≤–∞</div>';
            }
          };

          row.append(btn, rename, del);
          box.appendChild(row);
        });
      });

      $("#addStudent").onclick = async ()=>{
        const name = $("#newName").value.trim(); if(!name) return;
        const newRef = doc(colStudents());
        await setDoc(newRef, {name});
        $("#newName").value="";
      };
    }

    async function deleteStudentDeep(studentId){
      const batch = writeBatch(db);
      const gradesSnap = await getDocs(gradesCol(studentId));
      gradesSnap.forEach(d=> batch.delete(d.ref));
      const subjSnap = await getDocs(subjectsCol(studentId));
      subjSnap.forEach(d=> batch.delete(d.ref));
      batch.delete(doc(colStudents(), studentId));
      await batch.commit();
    }

    // helper: –¥–µ–ª–∞–µ–º ID –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–∑ –¥–∞—Ç—ã –∏ –ø—Ä–µ–¥–º–µ—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    const idFrom = (date, subject) => `${date}__${(subject||'').replaceAll('/','-')}`;

    function showStudent(studentId){
      activeStudentId = studentId;
      const detail = $("#detail");
      detail.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <h2 id="studentTitle">...</h2>
          <div class="row" style="margin:0">
            <select id="filterSubject"><option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option></select>
            <input id="fromDate" type="date"/><span class="muted">‚Äî</span><input id="toDate" type="date"/>
            <button id="btnApplyFilter">–§–∏–ª—å—Ç—Ä</button>
            <button id="btnExport">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
          </div>
        </div>

        <div class="row">
          <input id="dateInput" type="date"/>
          <select id="subjectSelect"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option></select>
          <input id="newSubject" placeholder="–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç"/>
          <button id="addSubject">Ôºã</button>
        </div>
        <div class="row">
          <input id="gradeInput" type="number" step="0.1" min="1" max="5" placeholder="–æ—Ü–µ–Ω–∫–∞"/>
          <button id="btnSet" class="primary">–ü–æ—Å—Ç–∞–≤–∏—Ç—å/–∑–∞–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="row">
          <button id="btnAvg">üìä –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</button>
          <span id="avgOut" class="muted"></span>
        </div>
        <table>
          <thead><tr><th>–î–∞—Ç–∞</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th><th></th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      `;

      // –∑–∞–≥–æ–ª–æ–≤–æ–∫
      getDoc(doc(colStudents(), studentId)).then(d=>{
        $("#studentTitle").textContent = d.data()?.name || "–£—á–µ–Ω–∏–∫";
      });

      // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç—ã
      unsubSubjects && unsubSubjects();
      unsubSubjects = onSnapshot(subjectsCol(studentId), snap=>{
        subjects = [];
        snap.forEach(d=> subjects.push(d.id));
        renderSubjects();
      });

      function renderSubjects(){
        const sel = $("#subjectSelect");
        const filt = $("#filterSubject");
        sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>' + subjects.map(s=>`<option>${s}</option>`).join("");
        filt.innerHTML = '<option value="">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</option>' + subjects.map(s=>`<option>${s}</option>`).join("");
      }

      $("#addSubject").onclick = async ()=>{
        const s = $("#newSubject").value.trim();
        if(!s) return;
        await setDoc(doc(subjectsCol(studentId), s), {created: Date.now()});
        $("#newSubject").value="";
      };

      // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—Ü–µ–Ω–∫–∏
      unsubGrades && unsubGrades();
      const reloadGrades = ()=>{
        unsubGrades && unsubGrades();
        const qBase = query(gradesCol(studentId), orderBy("date"));
        unsubGrades = onSnapshot(qBase, drawTable);
      };
      reloadGrades();

      function drawTable(snap){
        const rows=[]; let sum=0, n=0;
        const subjFilter = $("#filterSubject").value;
        const from = $("#fromDate").value || "0000-00-00";
        const to   = $("#toDate").value   || "9999-12-31";

        snap.forEach(d=>{
          const g = { id:d.id, ...d.data() };
          if (g.date < from || g.date > to) return;
          if (subjFilter && g.subject !== subjFilter) return;
          rows.push(g);
          sum+=Number(g.grade); n++;
        });

        const tbody = $("#tbody");
        tbody.innerHTML = rows.map(g=>`
          <tr>
            <td>${g.date}</td>
            <td>${g.subject || ""}</td>
            <td>${g.grade}</td>
            <td>
              <button data-id="${g.id}" class="edit">–ü–æ–º–µ–Ω—è—Ç—å</button>
              <button data-id="${g.id}" class="del">–£–±—Ä–∞—Ç—å</button>
            </td>
          </tr>`).join("");

        $("#btnAvg").onclick = ()=>{
          $("#avgOut").textContent = n ? ` = ${(sum/n).toFixed(2)}` : " ‚Äî –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ –ø–æ —Ñ–∏–ª—å—Ç—Ä—É";
        };

        tbody.querySelectorAll(".del").forEach(b=>{
          b.onclick = ()=> deleteDoc(doc(gradesCol(studentId), b.dataset.id));
        });

        tbody.querySelectorAll(".edit").forEach(b=>{
          b.onclick = async ()=>{
            const cur = rows.find(r=>r.id===b.dataset.id);
            const v = prompt(`–ù–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è ${cur.date} (${cur.subject}):`, String(cur.grade));
            if(!v) return;
            const num = Number(String(v).replace(",", "."));
            if(Number.isNaN(num)) return alert("–ù—É–∂–Ω–æ —á–∏—Å–ª–æ");
            await setDoc(doc(gradesCol(studentId), b.dataset.id), {date:cur.date, subject:cur.subject, grade:num});
          };
        });

        $("#btnExport").onclick = ()=> exportCSV(rows);
        $("#btnApplyFilter").onclick = ()=> drawTable(snap); // –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å –Ω–æ–≤—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
      }

      $("#btnSet").onclick = async ()=>{
        const d = $("#dateInput").value;
        const s = $("#subjectSelect").value;
        const v = $("#gradeInput").value;
        if(!d || !s || !v) return alert("–ù—É–∂–Ω—ã –¥–∞—Ç–∞, –ø—Ä–µ–¥–º–µ—Ç –∏ –æ—Ü–µ–Ω–∫–∞");
        const num = Number(String(v).replace(",", "."));
        if(Number.isNaN(num)) return alert("–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º");
        const id = idFrom(d, s);
        await setDoc(doc(gradesCol(studentId), id), {date:d, subject:s, grade:num});
        $("#gradeInput").value="";
      };
    }

    function exportCSV(rows){
      const header = ["–î–∞—Ç–∞","–ü—Ä–µ–¥–º–µ—Ç","–û—Ü–µ–Ω–∫–∞"];
      const lines = [header.join(",")].concat(
        rows.map(r=>[r.date, r.subject||"", r.grade].join(","))
      );
      const csv = "\uFEFF" + lines.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "grades.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
